<?php
/**
 * @package		Joomla.Site
 * @subpackage	com_content
 * @copyright	Copyright (C) 2005 - 2013 Open Source Matters, Inc. All rights reserved.
 * @license		GNU General Public License version 2 or later; see LICENSE.txt
 */

// no direct access
defined('_JEXEC') or die;

JHtml::_('behavior.keepalive');
JHtml::_('behavior.tooltip');
JHtml::_('behavior.calendar');
JHtml::_('behavior.formvalidation');

// Create shortcut to parameters.
$params = $this->state->get('params');
//$images = json_decode($this->item->images);
//$urls = json_decode($this->item->urls);

// This checks if the editor config options have ever been saved. If they haven't they will fall back to the original settings.
$editoroptions = isset($params->show_publishing_options);
if (!$editoroptions):
	$params->show_urls_images_frontend = '0';
endif;

$doc				= JFactory::getDocument();
$doc->addScript(JURI::base().'templates/beez_20/javascript/hiding.js', 'text/javascript');

$app = JFactory::getApplication();
?>

<style type="text/css">

    #contentarea{
        padding: 0 !important;
    }

    #breadcrumbs{
        margin: 0 !important;
    }

    #wrapper2{
        width: 100% !important;
        padding: 0 !important;
    }

    #main{
        padding: 0 !important;
    }
	label.iPhoneCheckLabelOn, label.iPhoneCheckLabelOff{
        font-family: georgia !important;
        font-size: 12px !important;
        color: #898989 !important;
        text-shadow: none;
    }
</style>

<script type="text/javascript">

    var show_on_before_unload_msg = true;
    var editor_font_increase = 0;
    var formChange = false;
    var changeImg = false;

    window.onbeforeunload = function(e){

        checkFormChange();

        if(show_on_before_unload_msg && formChange){
            return '';
        }

    };

    function checkFormChange(){

        formChange = false;

        if($('#jform_title').val() != $('#jform_title_default').val()){
            formChange = true;
        }

        if($("#text-editor-default").html() != $("#text-editor").wysiwyg("getContent")){
            formChange = true;
        }

        if($('#jform_catid_default').val() != $('#jform_catid').val()){
            formChange = true;
        }

        if(changeImg){
            formChange = true;
        }

        $('.tag-id-input-hidden').each(function(){
            if($(this).val() == 0){
                formChange = true;
                return false;
            }
        });

    }

    function remove_red_edges(){
        $('#jform_title').removeClass('write-invalid');
        $('#jform_title').removeClass('invalid');
        $('#text-editor-wysiwyg-iframe').removeClass('write-invalid');
        $('#category-select-current').removeClass('write-invalid');
        $('#tags-content').removeClass('write-invalid');
        //$('.defaultSkin table.mceLayout').removeClass('write-invalid');
        //$('.defaultSkin table.mceLayout tr.mceFirst td').removeClass('write-invalid');
        //$('.defaultSkin table.mceLayout tr.mceLast td').removeClass('write-invalid');
    }

	Joomla.submitbutton = function(task, publish,target) {


        show_on_before_unload_msg = false;

		if(publish){
            $('#jform_state').val(1);
        }
        else{
            $('#jform_state').val(0);
        }

		if($('#jform_alias').val()!=""){
			var titulo = $('#jform_title').val();
			var s1= titulo.replace(/[^0-9a-zA-Z]/g, ' ');
			$('#jform_alias').val(s1);
		}
		
        $('#accionpost').val(target);
	
        var success = true;
		
        var jform_title = $('#jform_title');

        remove_red_edges();

        if($(jform_title).val() == ''){
            $(jform_title).addClass('write-invalid');
            success = false;
        }

        var txt = $("#text-editor").val();
        txt = strip_html_tags(txt);
		
		if(publish){

            if((txt.length < 1000) || (txt.length > 3000)){
                $('#text-editor-wysiwyg-iframe').addClass('write-invalid');
                success = false;
            }

            if($('#jform_catid').val() == 0){
                $('#category-select-current').addClass('write-invalid');
                success = false;
            }

			var tag_length = $('.tag').length;

			if(tag_length == 0){
				$('#tags-content').addClass('write-invalid');
				success = false;
			}

		}
        else{

            if(txt.length == 0){
                $('#text-editor-wysiwyg-iframe').addClass('write-invalid');
                success = false;
            }

        }
	
		if (/*(task == 'article.cancel' || document.formvalidator.isValid(document.id('adminForm'))) &&*/ success) {
			<?php echo $this->form->getField('articletext')->save(); ?>
			Joomla.submitform(task);

            //$('#publish-button').attr("disabled", true);
            $('#preview-popup-publish-text-button').attr("disabled", true);
            //$('#save_button').attr("disabled", true);

            $('#save-button-progress').width($('#save_button').outerWidth());
            $('#save_button').hide();
            $('#save-button-progress').show();

            $('#publish-button-progress').width($('#publish-button').outerWidth());
            $('#publish-button').hide();
            $('#publish-button-progress').show();

		}else{
			hideAllTopBarSliders();
			if (publish==false){
				$('#forgot-password').lightbox_me({
						centered: true,
						closeSelector: '#close-forgot-pass-required-popup',
                        onClose: remove_red_edges
				});
			}else{
				$('#reset-password').lightbox_me({
						centered: true,
						closeSelector: '#close-reset-pass-required-popup',
                        onClose: remove_red_edges
				});
			}

            show_on_before_unload_msg = true;
		}
	}

    var search_tags_url = '<?php echo $this->baseurl."/index.php?option=com_content&task=search_tags" ?>';
    var exist_tag_url = '<?php echo $this->baseurl."/index.php?option=com_content&task=exist_tag" ?>';
    var delete_tag_url = '<?php echo $this->baseurl."/index.php?option=com_content&task=delete_tag" ?>';
    var delete_image_url = '<?php echo $this->baseurl."/index.php?option=com_content&task=delete_image_url" ?>';
	
    var add_tag_url = '<?php echo $this->baseurl."/index.php?option=com_content&task=add_tag" ?>';
    var delete_icon_url = '<?php echo JURI::base() . "templates/beez_20/images/remove.png"; ?>';

    var REMOVE = '<?php echo JText::_('REMOVE') ?>';
    var ARE_YOU_SURE = '<?php echo JText::_('ARE_YOU_SURE') ?>';
    var SELECT_A_TAG = '<?php echo JText::_('SELECT_A_TAG') ?>';
    var TAG_ALREADY_SELECTED = '<?php echo JText::_('TAG_ALREADY_SELECTED') ?>';
    var ENTER_TITLE = '<?php echo JText::_('ENTER_TITLE') ?>';
    var BY = '<?php echo JText::_('BY') ?>';
	
    var USERNAME = '<?php echo addslashes(JFactory::getUser()->get('username')) ?>';
    var NAME = '<?php echo addslashes(JFactory::getUser()->get('name')) ?>';
	
    var TAGS = '<?php echo JText::_('TAGS') ?>';
    var SELECT_A_CATEGORY = '<?php echo JText::_('SELECT_A_CATEGORY') ?>';
    var SELECT_A_CATEGORY_COLOR = '000000';

    var edit = <?php echo ($this->item->id)? "true" : "false" ?>;
    var text_id = <?php echo ($this->item->id)? $this->item->id : "0" ?>;
    var tag_index = 0;
    var interval1; 
    var category_select_dropdown_hidden = true;
    var categories_color = new Array();
    var dropbox;
    //var can_save = true;

    function setCurrentCategoryInDropdown(categoryId, categoryTitle, categoryColorCode){
        $('#category-select-current').data('categoryTitle', categoryTitle);
        $('#category-select-current').data('categoryColorCode', categoryColorCode);
        $('#current-category-color').css('background', '#'+categoryColorCode);
        $('#current-category-name').text(categoryTitle);
        $('#jform_catid').val(categoryId);
    }
	/*function setCurrentStateInDropdown(stateId, stateTitle){
        $('#state-select-current').data('stateTitle', stateTitle);
        $('#current-state-name').text(categoryTitle);
        $('#jform_state').val(stateId);
    }*/

    function resize_tag_box(){

        var last_tag = $('.tag:last');

        if(last_tag.length == 0){
            $('#tag-box').width('398px');
        }
        else{
            var tag_box = $('#tag-box').detach();
            var last_tag_position = last_tag.position();
            var tag_box_width = $('#tags-list').width() - (last_tag_position.left+$(last_tag).outerWidth()+2);

            if(tag_box_width < 100){
                tag_box_width = 398;
            }

            $(tag_box).width(tag_box_width+'px');
            tag_box.appendTo("#tags-list");
        }

        $('#tag-field').focus();

        //can_save = true;

    }

    function setCharsCountValue(){

       // if(tinyMCE.activeEditor != null){
            //var txt = tinyMCE.activeEditor.getContent();
			var txt = $('#jform_articletext').val();
			//alert(txt);
            //strip the html
            
			/*txt = txt.replace(/(<([^>]+)>)/ig,"");//Remueve los tags
            txt = txt.replace(/\n/gi,"");//Remueve los saltos de linea
            txt = $("<div/>").html(txt).text();
			*/
            $('#chars-count').text(txt.length);
            if((txt.length < 1000) || (txt.length > 3000)){
                $('#chars-count').attr('class', 'insufficient-chars-count');
                $('#publish-button').attr('disabled', true);
                $('#preview-popup-publish-text-button').attr('disabled', true);
            }
            else{
                $('#chars-count').attr('class', 'enough-chars-count');
                $('#publish-button').attr('disabled', false);
                $('#preview-popup-publish-text-button').attr('disabled', false);
            }

           // clearInterval(interval1);
      //  }

    }

    function strip_html_tags(html){
        html = html.replace(/(<([^>]+)>)/ig,"");//Remueve los tags
        html = html.replace(/\n/gi,"");//Remueve los saltos de linea
        html = $("<div/>").html(html).text();
        return html;
    }

    function setCharsCountValue2(){

        if($("#text-editor").wysiwyg("getContent") == null){
            return false;
        }
        else{
            clearInterval(interval1);
        }

        var txt = $("#text-editor").wysiwyg("getContent");

        //strip the html
        txt = strip_html_tags(txt);


        $('#chars-count').text(txt.length);
        if((txt.length < 1000) || (txt.length > 3000)){
            $('#chars-count').attr('class', 'insufficient-chars-count');
            $('#publish-button').attr('disabled', true);
            $('#preview-popup-publish-text-button').attr('disabled', true);
        }
        else{
            $('#chars-count').attr('class', 'enough-chars-count');
            $('#publish-button').attr('disabled', false);
            $('#preview-popup-publish-text-button').attr('disabled', false);
        }

    }

    function createTag(tagId, tagName){

        if(checkTagSelected(tagId, tagName)){
            alert(TAG_ALREADY_SELECTED.replace("{tag}", tagName));
            $('#tag-field').val('');
            return;
        }

        var div_remove_tag = $('<div data-tag-id="'+tag_index+'" />');
        $(div_remove_tag).addClass('remove-tag');
        $(div_remove_tag).attr('title', REMOVE);

        var tag_name = $('<div/>');
        $(tag_name).addClass('tag-name');
        $(tag_name).text(tagName);

        var tag_hidden = $('<input/>');
        $(tag_hidden).attr('type', 'hidden');
        $(tag_hidden).attr('name', 'tags['+tag_index+'][id]');
        $(tag_hidden).attr('class', 'tag-id-input-hidden');
        $(tag_hidden).val(tagId);

        var tag_hidden2 = $('<input/>');
        $(tag_hidden2).attr('type', 'hidden');
        $(tag_hidden2).attr('name', 'tags['+tag_index+'][name]');
        $(tag_hidden2).attr('class', 'tag-name-input-hidden');
        $(tag_hidden2).val(tagName);

        var tag_div = $('<div data-tag-id="'+tag_index+'" />');
        $(tag_div).addClass('tag');

        $(tag_name).appendTo($(tag_div));
        $(div_remove_tag).appendTo($(tag_div));
        $(tag_hidden).appendTo($(tag_div));
        $(tag_hidden2).appendTo($(tag_div));

        $(tag_div).appendTo($('#tags-list'));

        $('#tag-field').val('');
        tag_index++;

        resize_tag_box();

    }

    function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object
        $('#article-image-error').hide();
        // Loop through the FileList and render image files as thumbnails.
        for (var i = 0, f; f = files[i]; i++) {

            // Only process image files.
            /*if (!f.type.match('image.*')) {
                continue;
            }*/

            if(!(
                f.type == 'image/gif'
                || f.type == 'image/jpg'
                || f.type == 'image/jpeg'
                || f.type == 'image/png'
                )
               )
            {
                $('#article-image-error .register-form-error-center').text('La imagén debe ser gif, png, jpeg o jpg');
                $('#article-image-error').fadeIn('slow');
                return false;
            }

            var reader = new FileReader();

            // Closure to capture the file information.
            reader.onload = (function(theFile) {
                return function(e) {

                    var remove_picture = $('<div id="remove-picture"/>');
                    $(remove_picture).attr("title", DELETE_IMAGE);

                    var picture_name = $('<div id="picture-name"/>');
                    $(picture_name).text(escape(theFile.name));

                    var img = $('<img/>');
                    $(img).attr('src', e.target.result);

                    var image_info = $('<div id="image-info"/>');
                    $(picture_name).appendTo($(image_info));
                    $(remove_picture).appendTo($(image_info));

                    var text_picture = $('<div id="text-picture"/>');
                    $(image_info).appendTo($(text_picture));
                    $(img).appendTo($(text_picture));

                    $('#image-content').html($(text_picture));

                    changeImg = true;
                };
            })(f);

            // Read in the image file as a data URL.
            reader.readAsDataURL(f);
        }
    }

    function noopHandler(evt) {
        evt.stopPropagation();
        evt.preventDefault();
    }

    function drop(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var f = evt.dataTransfer.files[0];

        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = (function(theFile) {
            return function(e) {

                var remove_picture = $('<div id="remove-picture"/>');
                $(remove_picture).attr("title", DELETE_IMAGE);

                var picture_name = $('<div id="picture-name"/>');
                $(picture_name).text(escape(theFile.name));

                var img = $('<img/>');
                $(img).attr('src', e.target.result);

                var image_info = $('<div id="image-info"/>');
                $(picture_name).appendTo($(image_info));
                $(remove_picture).appendTo($(image_info));

                var text_picture = $('<div id="text-picture"/>');
                $(image_info).appendTo($(text_picture));
                $(img).appendTo($(text_picture));

                $('#image-content').html($(text_picture));

                changeImg = true;
            };
        })(f);

        // Read in the image file as a data URL.
        reader.readAsDataURL(f);

    }

    function changeToSelectTextImage(){

        var article_image_error = '<div id="article-image-error" class="register-form-error" style="display: none; bottom: 45px; right: -247px;">'
            +'<div class="register-form-error-left"></div>'
            +'<div class="register-form-error-center" style="max-width: 220px;"></div>'
            +'<div class="register-form-error-right"></div>'
            +'</div>';

        var select_image_container = $('<div id="select-image-container"/>');
        var select_image_icon = $('<div id="select-image-icon"/>');
        var select_image_text = $('<div id="select-image-text"/>');
        $(select_image_text).text(SELECT_IMAGE);

        $(select_image_icon).appendTo($(select_image_container));
        $(select_image_text).appendTo($(select_image_container));
        $(article_image_error).appendTo($(select_image_container));

        $('#image-content').html($(select_image_container));

        if ($.browser.msie) {
            $('#imagen1').replaceWith($('#imagen1').clone());
        }
        else {
            $('#imagen1').val('');
        }

        dropbox = document.getElementById('select-image-container');
        dropbox.addEventListener('dragenter', noopHandler, false);
        dropbox.addEventListener('dragexit', noopHandler, false);
        dropbox.addEventListener('dragover', noopHandler, false);
        dropbox.addEventListener('drop', drop, false);

    }

    $(document).ready(function(){

        $('#share-fb').iphoneStyle({ checkedLabel: JYES, uncheckedLabel: CHECK_NO,
            onChange: function(elem, value) {
                $('#share-hidden').val(value.toString());
            }
        });

        $('#comments').iphoneStyle({ checkedLabel: JYES, uncheckedLabel: CHECK_NO,
            onChange: function(elem, value) {
                $('#comments-hidden').val(value.toString());
            }
        });

        $('#jform_articletext').keyup(setCharsCountValue);

        interval1 = setInterval(setCharsCountValue2, 100);

        //$('#prueba-scroll').jScrollPane();

        resize_tag_box();

        dropbox = document.getElementById('select-image-container');
        if(dropbox != null){
            dropbox.addEventListener('dragenter', noopHandler, false);
            dropbox.addEventListener('dragexit', noopHandler, false);
            dropbox.addEventListener('dragover', noopHandler, false);
            dropbox.addEventListener('drop', drop, false);
        }


        document.getElementById('imagen1').addEventListener('change', handleFileSelect, false);

        $('#category-select2').width($('#category-select-dropdown').outerWidth());
        //$('#state-select2').width($('#state-select-dropdown').outerWidth());



        $("#text-editor").wysiwyg({
            rmUnusedControls: true,
            css: '<?php echo JURI::base()."templates/beez_20/css/wysiwyg.css"?>'
        });

        /*$.wysiwyg.rmFormat.enabled = true;
        $.wysiwyg.rmFormat.rmMsWordMarkup = true;
        $.wysiwyg.removeFormat($("#text-editor"));*/

        function paste(){
            //$("#text-editor").wysiwyg("selectAll");
            //$("#text-editor").wysiwyg("removeFormat");

            var newContent = cleanHTML($("#text-editor").wysiwyg("getContent"));
            $("#text-editor").wysiwyg("setContent", newContent);
        }

        // removes MS Office generated guff
        function cleanHTML(input) {
            // 1. remove line breaks / Mso classes
            var stringStripper = /(\n|\r| class=(")?Mso[a-zA-Z]+(")?)/g;
            var output = input.replace(stringStripper, ' ');
            // 2. strip Word generated HTML comments
            var commentSripper = new RegExp('<!--(.*?)-->','g');
            var output = output.replace(commentSripper, '');
            var tagStripper = new RegExp('<(/)*(a|img|b|i|u|meta|link|span|\\?xml:|st1:|o:|font)(.*?)>','gi');
            // 3. remove tags leave content if any
            output = output.replace(tagStripper, '');
            // 4. Remove everything in between and including tags '<style(.)style(.)>'
            var badTags = ['style', 'script','applet','embed','noframes','noscript'];

            for (var i=0; i< badTags.length; i++) {
                tagStripper = new RegExp('<'+badTags[i]+'.*?'+badTags[i]+'(.*?)>', 'gi');
                output = output.replace(tagStripper, '');
            }
            // 5. remove attributes ' style="..."'
            var badAttributes = ['style', 'start'];
            for (var i=0; i< badAttributes.length; i++) {
                var attributeStripper = new RegExp(' ' + badAttributes[i] + '="(.*?)"','gi');
                output = output.replace(attributeStripper, '');
            }
            return output;
        }

        $('#text-editor-wysiwyg-iframe').contents().find("body").bind("paste", function (e) {
            setTimeout(paste, 250);
        });


        $("#undo").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "undo");
            setCharsCountValue2();
        });

        $("#redo").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "redo");
            setCharsCountValue2();
        });

        $("#bold").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "bold");
        });

        $("#italic").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "italic");
        });

        $("#left").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "justifyLeft");
        });

        $("#center").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "justifyCenter");
        });

        $("#right-b").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "justifyRight");
        });

        $("#justify").click(function () {
            $("#text-editor").wysiwyg("triggerControl", "justifyFull");
        });

        $("#a-plus").click(function () {

            editor_font_increase++;
            if(editor_font_increase <= 3){
                $("#text-editor").wysiwyg("selectAll");
                $("#text-editor").wysiwyg("triggerControl", "increaseFontSize");
            }
            else{
                editor_font_increase--;
            }

        });

        $("#a-minus").click(function () {

            editor_font_increase--;
            if(editor_font_increase >= -3){
                $("#text-editor").wysiwyg("selectAll");
                $("#text-editor").wysiwyg("triggerControl", "decreaseFontSize");
            }
            else{
                editor_font_increase++;
            }

        });



        $(document.getElementById('text-editor-wysiwyg-iframe').contentWindow.document).keyup(setCharsCountValue2);

        <?php $articleImageErrors = $app->getUserState('article-image-errors'); ?>
        <?php if(!empty($articleImageErrors)): ?>
            $('#article-image-error .register-form-error-center').text('<?php echo $articleImageErrors[0]; ?>');
            $('#article-image-error').fadeIn('slow');
        <?php endif ?>
        <?php $app->setUserState('article-image-errors', array()); ?>

        $('#category-select-current').click(function(){

            if(category_select_dropdown_hidden){
                $('#current-category-arrow').removeClass('arrow-down');
                $('#current-category-arrow').addClass('arrow-up');
                $('#category-select-dropdown').slideDown('fast');
                category_select_dropdown_hidden = false;
            }
            else{
                $('#current-category-arrow').removeClass('arrow-up');
                $('#current-category-arrow').addClass('arrow-down');
                $('#category-select-dropdown').slideUp('fast');
                category_select_dropdown_hidden = true;
            }

        });
		
		/*$('#state-select-current').click(function(){

            if(category_select_dropdown_hidden){
                $('#current-state-arrow').removeClass('arrow-down');
                $('#current-state-arrow').addClass('arrow-up');
                $('#state-select-dropdown').slideDown('fast');
                category_select_dropdown_hidden = false;
            }
            else{
                $('#current-state-arrow').removeClass('arrow-up');
                $('#current-state-arrow').addClass('arrow-down');
                $('#state-select-dropdown').slideUp('fast');
                category_select_dropdown_hidden = true;
            }

        });*/
//		$('#help-share-facebook-bubble').fadeOut('slow');
		
		$("body").delegate("#help-share-facebook-icon", "hover", function() {
            $('#help-share-facebook-bubble').fadeIn('fast');
        });
		
        $('body').not('#category-select-dropdown').click(function(event){
            event.stopPropagation();
            var $target = $(event.target);
            if(!($target.is("#category-select-dropdown")) && !($target.is("#category-select2")) && !($target.is("#category-select-current")) && !($target.is("#current-category-color")) && !($target.is("#current-category-name*")) && !($target.is("#current-category-arrow"))){
                $('#current-category-arrow').removeClass('arrow-up');
                $('#current-category-arrow').addClass('arrow-down');
                $('#category-select-dropdown').slideUp('fast');
            }
        });

        $("#help-share-facebook-icon").live("mouseleave", function() {
            $('#help-share-facebook-bubble').fadeOut('fast');
        });

		$('.category').click(function(){
            $('#category-select-current').data('categoryTitle', $(this).data('categoryTitle'));

            var categoryColorCode = $(this).data('categoryColorCode');

            if(categoryColorCode == 0){
                categoryColorCode = "000000";
            }

            $('#category-select-current').data('categoryColorCode', categoryColorCode);

            $('#current-category-color').css('background', '#'+categoryColorCode);
            $('#current-category-name').text($(this).data('categoryTitle'));
            $('#jform_catid').val($(this).data('categoryId'));

            $('#current-category-arrow').removeClass('arrow-up');
            $('#current-category-arrow').addClass('arrow-down');
            $('#category-select-dropdown').slideUp('fast');
            category_select_dropdown_hidden = true;
        });
		
		/*$('.state').click(function(){
            $('#state-select-current').data('stateTitle', $(this).data('stateTitle'));

            $('#current-state-name').text($(this).data('stateTitle'));
            $('#current-state-arrow').removeClass('arrow-up');
			$('#jform_state').val($(this).data('stateId'));
            $('#current-state-arrow').addClass('arrow-down');
            $('#state-select-dropdown').slideUp('fast');
            category_select_dropdown_hidden = true;
        });*/

        $("body").delegate("#select-image-container", "click", function() {
            $('#imagen1').click();
        });

        $('.cancel-button').click(function(){

            var jform_state = $('#jform_state').val();
            var location = "index.php?option=com_users&view=profile&user_id="+USER_ID;

            switch(jform_state)
            {
                //Texto nuevo
                case "":
                    window.history.back();
                    break;
                //Texto borrador
                case "0":
                    location += "&draft=1";
                    window.location.href = location;
                    break;
                //Texto publicado
                case "1":
                    location += "&mytexts=1";
                    window.location.href = location;
                    break;
            }

            /*if(history.length > 1){
                window.history.back();
            }
            else{
                window.location.href = 'index.php?option=com_users&view=profile';
            }*/
        });

        /*$('#jform_title').focus(function(){
            if($(this).val() == ENTER_TITLE){
                $(this).val('');
            }
        });

        $('#jform_title').blur(function(){
            if($(this).val() == ''){
                $(this).val(ENTER_TITLE);
            }
        });*/

        $("body").delegate("#text-picture", "hover", function() {
            $('#image-info').fadeIn('slow');
        });

        $("#text-picture").live("mouseleave", function() {
            $('#image-info').fadeOut('slow');
        });

        $("body").delegate("#remove-picture", "click", function() {

                var text_id = $(this).data('textId');

                if(edit && text_id){

                    $.post(
                        delete_image_url,
                        {
                            "text_id": text_id
                        },
                        function(data){

                            if(data.result){

                                changeToSelectTextImage();

                            }

                        },
                        "json");
                }
                else{
                    changeToSelectTextImage();
                    changeImg = false;
                }

        });

        $('#tag-field').blur(function(){

            var tag_field_val = $.trim($(this).val().toLowerCase());

            if(tag_field_val != ""){

                createTag(0, tag_field_val);

            }
            else{
                $('#tag-field').val('');
            }

        });

        $('#tag-field').keyup(function(event){

            var tag_field_val = $.trim($(this).val().toLowerCase());

            if(event.keyCode == 188){//If the key pressed was a comma.

                tag_field_val = tag_field_val.replace(",", "");

                if(tag_field_val != ""){

                    //can_save = false;
                    createTag(0, tag_field_val);
                    /*$.post(
                        exist_tag_url,
                        {
                            "search": tag_field_val
                        },
                        function(data){

                            if(data.tag == null){

                                createTag(0, tag_field_val);

                            }
                            else{

                                createTag(data.tag.id, data.tag.name)

                            }
                            $('#tag-field').focus();

                        }, "json");*/

                }
                else{
                    $('#tag-field').val('');
                }
            }
            //esta es la parte que trae el dropdown de tags.
            /*else{

                $.post(
                    search_tags_url,
                    {
                        "search": tag_field_val
                    },
                    function(data){

                        if(data.tags.length == 0){
                            $('#tag-select').fadeOut('fast');

                            $('#tag-dropdown').slideUp('fast');
                        }
                        else{

                            $('#tag-dropdown').html('');

                            for(var i=0; i<data.tags.length; i++){

                                var custom_dropdown_item = $('<div class="custom-dropdown-item" data-value="'+data.tags[i].id+'"></div>');
                                $(custom_dropdown_item).text(data.tags[i].name);
                                $(custom_dropdown_item).appendTo($('#tag-dropdown'));

                            }

                            $('#tag-dropdown').slideDown('fast');
                        }


                    }, "json");
            }*/

        });

		
		$("body").delegate('.remove_image', 'click', function(){

           if(confirm(ARE_YOU_SURE)){

              if(edit){

                   $.post(
                       delete_image_url,
                       {
                           "text_id": text_id
                       },
                       function(data){

                           if(data.result){
                               $('.cajaimagen').fadeOut('slow');
                           }
                       }, "json");
               }
           }

        });
		

        $("body").delegate('.remove-tag', 'click', function(){

               var tag_index = $(this).data('tagId');

               var tag_id = $('.tag[data-tag-id="'+tag_index+'"] input[name="tags['+tag_index+'][id]"]').val();

               if(edit && (tag_id != "0")){

                   $.post(
                       delete_tag_url,
                       {
                           "tag_id": tag_id,
                           "text_id": text_id
                       },
                       function(data){

                           if(data.result){
                               $('.tag[data-tag-id="'+tag_index+'"]').fadeOut('fast',function(){
                                   $(this).remove();
                                   resize_tag_box();
                               });
                           }

                       }, "json");
               }
               else{
                   $('.tag[data-tag-id="'+tag_index+'"]').fadeOut('fast',function(){
                       $(this).remove();
                       resize_tag_box();
                   });
               }

        });
		

        $("body").delegate('.custom-dropdown-item', 'click', function(){
            createTag($(this).data('value'), $(this).text());
            $('#tag-select').fadeOut('fast');
            $('#tag-dropdown').slideUp('fast');

        });

        $("#jform_title").focus(function() {
            if($(this).val() == ""){
                $(this).removeClass('empty');
                $(this).addClass('full');
            }
        });

        $('#jform_title').blur(function() {
            if($(this).val() == ""){
                $(this).removeClass('full');
                $(this).addClass('empty');
            }
        });

        /*$("body").delegate('a, #login-link-container, #close-icon, #cancel-button', 'click', function(event){

            var ok = confirm('Deseas salir?');
            if(!ok){
                event.preventDefault();
                event.stopPropagation();
                return false;
            }

        });*/

    });

    function checkTagSelected(tag_id, tag_name){

        var exist = false;

        $('.tag-id-input-hidden').each(function() {

            if((tag_id != "0") && (tag_id == $(this).val())){
                exist = true;
                return;
            }

        });

        if(!exist){

            $('.tag-name-input-hidden').each(function() {

                if(tag_name == $(this).val().toLowerCase()){
                    exist = true;
                    return;
                }

            });

        }

        return exist;
    }
</script>

<div id="write-text-form"  style="overflow:inherit !important;" class="edit item-page<?php echo $this->pageclass_sfx; ?>">

<div id="close-icon" class="cancel-button" title="<?php echo JText::_('JCANCEL') ?>"></div>
<form enctype= "multipart/form-data" action="<?php echo JRoute::_('index.php?option=com_content&a_id='.(int) $this->item->id); ?>" method="post" name="adminForm" id="adminForm" class="form-validate">

            <input type="hidden" name="jform[id]" value="<?php echo ($this->item->id)? $this->item->id : -1 ?>">

            <?php $jform = $app->getUserState('jform'); 
		//	var_dump($jform);die;
			?>

			<div class="formelm" id="text-title-form">
			    <?php //echo $this->form->getInput('title', null, ($this->item->title)? $this->item->title : JText::_('ENTER_TITLE'));
                    $jform_title_class = 'empty';
                    if(isset($this->item->title) || ($this->item->title != '')){
                        $jform_title_class = 'full';
                    }

                    $title = ($jform['title'])?  $jform['title'] : $this->item->title;
					$alias = ($jform['title'])?  $jform['title'] : $this->item->title;
					$alias = str_replace('?','',$alias);
					$alias = str_replace('¿','',$alias);
					$alias = str_replace('!','',$alias);
					$alias = str_replace('¡','',$alias);
					$alias = str_replace(' ','-',$alias);
                ?>
                <input type="text" name="jform[title]" id="jform_title" maxlength="100" autocomplete="off" value="<?php echo $title ?>" placeholder="<?php echo JText::_('ENTER_TITLE') ?>" class="inputbox required <?php echo $jform_title_class ?>" size="30" required="required" />
                <input type="hidden" id="jform_title_default" name="jform_title_default" value="<?php echo $title ?>">
                <input type="hidden" name="jform[alias]" id="jform_alias" value="<?php echo $alias ?>"/>
			</div>
			

            <div id="editor-options">
                <div id="undo"></div>
                <div id="redo"></div>
                <div id="bold"></div>
                <div id="italic"></div>
                <div id="left"></div>
                <div id="center"></div>
                <div id="right-b"></div>
                <div id="justify"></div>
                <div id="a-plus"></div>
                <div id="a-minus"></div>
                <div style="clear: both;"></div>
            </div>

            <?php
                $this->item->introtext = ($this->item->introtext)? $this->item->introtext : '<br><br><span></span>';
                $introtext = ($jform['articletext'])?  $jform['articletext'] : $this->item->introtext;
            ?>
            <textarea id="text-editor" name="jform[articletext]"><?php echo $introtext ?></textarea>
            <div id="text-editor-default" style="display: none;"><?php echo $introtext ?></div>

		<?php if (is_null($this->item->id)):?>
			<div class="formelm">
			<?php echo $this->form->getLabel('alias','style=display:none;'); ?>
			<?php echo $this->form->getInput('alias','style=display:none;'); ?>
			</div>
		<?php endif; ?>

		

			<?php //echo $this->form->getInput('articletext'); ?>


        <div id="char-counter-save-container">

            <div id="char-counter">

                <div class="char-counter-number">1000</div>
                <div class="char-counter-lt">&le;</div>
                <div id="chars-count" class="insufficient-chars-count">0</div>
                <div class="char-counter-lt">&le;</div>
                <div class="char-counter-number">3000</div>

            </div>

            <div id="save-button-container">
                <?php if ($this->item->state==0){?>

                    <div id="save-button-progress" class="dot-progress-button"></div>
					<button type="button" id="save_button" class="write-text-form-button" onclick="Joomla.submitbutton('article.save', false, 'same')">
						<?php echo JText::_('JSAVE') ?>
					</button>
				<?php }else{?>
                    <div id="publish-button-container">
                        <div id="publish-button-progress" class="dot-progress-button"></div>
                        <button type="button" id="publish-button" class="write-text-form-button" onclick="Joomla.submitbutton('article.save', true, 'mytexts')">
                            Actualizar
                        </button>
                    </div>
				<?php }?>
            </div>

        </div>


	<?php if ($params->get('show_urls_images_frontend')  ): ?>
	<fieldset>
		<legend><?php echo JText::_('COM_CONTENT_IMAGES_AND_URLS'); ?></legend>
			<div class="formelm">
			<?php echo $this->form->getLabel('image_intro', 'images'); ?>
			<?php echo $this->form->getInput('image_intro', 'images'); ?>
			</div>
			<div style="clear:both"></div>
			<div class="formelm">
			<?php echo $this->form->getLabel('image_intro_alt', 'images'); ?>
			<?php echo $this->form->getInput('image_intro_alt', 'images'); ?>
			</div>
			<div class="formelm">
			<?php echo $this->form->getLabel('image_intro_caption', 'images'); ?>
			<?php echo $this->form->getInput('image_intro_caption', 'images'); ?>
			</div>
			<div class="formelm">
			<?php echo $this->form->getLabel('float_intro', 'images'); ?>
			<?php echo $this->form->getInput('float_intro', 'images'); ?>
			</div>

			<div class="formelm">
			<?php echo $this->form->getLabel('image_fulltext', 'images'); ?>
			<?php echo $this->form->getInput('image_fulltext', 'images'); ?>
			</div>
			<div style="clear:both"></div>
			<div class="formelm">
			<?php echo $this->form->getLabel('image_fulltext_alt', 'images'); ?>
			<?php echo $this->form->getInput('image_fulltext_alt', 'images'); ?>
			</div>
			<div class="formelm">
			<?php echo $this->form->getLabel('image_fulltext_caption', 'images'); ?>
			<?php echo $this->form->getInput('image_fulltext_caption', 'images'); ?>
			</div>
			<div class="formelm">
			<?php echo $this->form->getLabel('float_fulltext', 'images'); ?>
			<?php echo $this->form->getInput('float_fulltext', 'images'); ?>
			</div>

			<div  class="formelm">
			<?php echo $this->form->getLabel('urla', 'urls'); ?>
			<?php echo $this->form->getInput('urla', 'urls'); ?>
			</div>
			<div  class="formelm">
			<?php echo $this->form->getLabel('urlatext', 'urls'); ?>
			<?php echo $this->form->getInput('urlatext', 'urls'); ?>
			</div>
			<?php echo $this->form->getInput('targeta', 'urls'); ?>
			<div  class="formelm">
			<?php echo $this->form->getLabel('urlb', 'urls'); ?>
			<?php echo $this->form->getInput('urlb', 'urls'); ?>
			</div>
			<div  class="formelm">
			<?php echo $this->form->getLabel('urlbtext', 'urls'); ?>
			<?php echo $this->form->getInput('urlbtext', 'urls'); ?>
			</div>
			<?php echo $this->form->getInput('targetb', 'urls'); ?>
			<div  class="formelm">
			<?php echo $this->form->getLabel('urlc', 'urls'); ?>
			<?php echo $this->form->getInput('urlc', 'urls'); ?>
			</div>
			<div  class="formelm">
			<?php echo $this->form->getLabel('urlctext', 'urls'); ?>
			<?php echo $this->form->getInput('urlctext', 'urls'); ?>
			</div>
			<?php echo $this->form->getInput('targetc', 'urls'); ?>


	</fieldset>
	<?php endif; ?>

    <div id="configuration-container">

        <div id="configuration-img">
            <?php echo JText::_('CONFIGURING_PUBLICATION')?>
        </div>

        <div id="configuration-content">

            <div id="tags-container">
                <div id="tags-title" class="configuration-content-title"><?php echo JText::_('TAGS') ?></div>
                <div id="tags-content">
                    <div id="tags-list">

                        <?php
                            $this->tags = (count($jform['tags']))? $jform['tags'] : $this->tags;
                        ?>

                        <?php if(count($this->tags) > 0): ?>

                            <?php foreach($this->tags as $index => $tag): ?>
                            <?php $tag = (object)$tag;?>
                            <div class="tag" data-tag-id="<?php echo $index ?>">
                                <div class="tag-name"><?php echo $tag->name ?></div>
                                <div class="remove-tag" data-tag-id="<?php echo $index ?>" title="<?php echo JText::_('REMOVE') ?>"></div>
                                <input type="hidden" class="tag-id-input-hidden" name="tags[<?php echo $index ?>][id]" value="<?php echo $tag->id ?>">
                                <input type="hidden" class="tag-name-input-hidden" name="tags[<?php echo $index ?>][name]" value="<?php echo $tag->name ?>">
                            </div>

                            <?php endforeach ?>

                            <script type="text/javascript">
                                tag_index = <?php echo count($this->tags) ?>;
                            </script>

                        <?php endif ?>

                        <div id="tag-box">
                            <input type="text" name="tag-field" id="tag-field" autocomplete="off">
                            <div class="custom-dropdown" id="tag-dropdown"></div>
                        </div>

                    </div>

                    <div style="clear: both;"></div>
                </div>
            </div>

            <div id="categories-container">
                <div id="categories-title" class="configuration-content-title"><?php echo JText::_('CATEGORY') ?></div>

                <div id="category-select2">
                    <div id="category-select-current" data-category-title="<?php echo JText::_('SELECT_A_CATEGORY') ?>" data-category-color-code="f1f1f1">

                        <div id="current-category-color"></div>
                        <div id="current-category-name"><?php echo JText::_('SELECT_A_CATEGORY') ?></div>
                        <div id="current-category-arrow" class="arrow-down"></div>

                    </div>

                    <?php
                        $this->item->catid = ($this->item->catid)? $this->item->catid : 0;
                        $this->item->catid = ($jform['catid'])? $jform['catid'] : $this->item->catid;
                    ?>
                    <div id="category-select-dropdown">
                        <?php foreach(ideary::getCategoriesForCombo() as $category): ?>
                            <?php if($category->id == $this->item->catid): ?>
                            <script type="text/javascript">
                                setCurrentCategoryInDropdown('<?php echo $category->id ?>', '<?php echo $category->title ?>', '<?php echo $category->color_code ?>');
                            </script>
                            <?php endif ?>
                        <div class="category" data-category-id="<?php echo $category->id ?>" data-category-title="<?php echo $category->title ?>" data-category-color-code="<?php echo $category->color_code ?>">
                            <div class="category-color2" style="background: #<?php echo $category->color_code ?>;"></div>
                            <div class="category-name"><?php echo $category->title ?></div>
                        </div>
                        <?php endforeach; ?>
                    </div>

                    <input type="hidden" value="<?php echo $this->item->catid; ?>" id="jform_catid" name="jform[catid]" class="inputbox required" aria-required="true" required="required" aria-invalid="false">
                    <input type="hidden" value="<?php echo $this->item->catid; ?>" id="jform_catid_default">

                </div>
            </div>

            <?php $app->setUserState('jform', null); ?>
			
			<input type="hidden" id="jform_state" name="jform[state]" value="<?php echo $this->item->state?>"/>
			<input type="hidden" id="accionpost" name="accionpost" value="same"/>
				
            <div id="image-container">
                <div id="image-title" class="configuration-content-title"><?php echo JText::_('IMAGE') ?></div>

                <div id="image-content">
                    <?php if($this->image && ideary::existAllImagesOfText($this->item->id, $this->image->image_name))://si tiene imagen?>
                        <div id="text-picture">
                            <div id="image-info">
                                <div id="picture-name"><?php echo $this->image->image_name ?></div>
                                <div id="remove-picture" title="<?php echo JText::_('DELETE_IMAGE') ?>" data-text-id="<?php echo $this->item->id ?>"></div>
                            </div>
                            <img src="<?php echo JURI::base()."templates/beez_20/images/texts/".$this->item->id."/edit/".$this->image->image_name ?>">
                        </div>
                    <?php else: ?>
                        <div id="select-image-container">
                            <div id="select-image-icon"></div>
                            <div id="select-image-text"><?php echo JText::_('SELECT_IMAGE') ?></div>

                            <div id="article-image-error" class="register-form-error" style="display: none; bottom: 45px; right: -247px;">
                                <div class="register-form-error-left"></div>
                                <div class="register-form-error-center" style="max-width: 220px;"></div>
                                <div class="register-form-error-right"></div>
                            </div>

                        </div>
                    <?php endif ?>
                </div>
            </div>

            <div id="iphone-switches-container">

                <!--<div id="allow_comments" class="iphone-switch-content">
                    <div class="iphone-switch-text"><?php //echo JText::_('ALLOW_COMMENTS') ?></div>
                    <div class="iphone-switch">
                        <input type="checkbox" name="comments" id="comments" <?php //echo ($this->item->allow_comments)? 'checked="checked"' : '' ?> >
                    </div>
                </div>
                <input type="hidden" id="comments-hidden" name="jform[comments]" value="<?php //echo ($this->item->allow_comments)? 'true' : 'false' ?>">
-->
                <div id="help-share-facebook" style="display:none;">
                    <div id="share_facebook" class="iphone-switch-content">
                        <div class="iphone-switch-text"><?php echo JText::_('SHARE_ON_FB') ?></div>
                        <div class="iphone-switch">
                            <input type="checkbox" name="share" id="share-fb">
                        </div>


                    </div>
                    <input type="hidden" id="share-hidden" name="jform[share]" value="false">

                    <div id="help-share-facebook-icon">
                        <div id="help-share-facebook-bubble" style="display:none;">
                            <div id="help-share-facebook-bubble-left"></div>
                            <div id="help-share-facebook-bubble-center">
                                Habilitá esta opción para publicar tu texto en facebook.
                            </div>
                            <div id="help-share-facebook-bubble-right"></div>
                            <div style="clear: both;"></div>
                        </div>
                    </div>

                    <div style="clear: both;"></div>
                </div>

            </div>

        </div>
        <div style="clear: both;"></div>
    </div>

            <div id="buttons-container">

                <button type="button" id="cancel-button" class="write-text-form-button cancel-button">
                    <?php echo JText::_('JCANCEL') ?>
                </button>

                 <?php if ($this->item->state==0){?>
                     <div id="publish-button-container">
                         <div id="publish-button-progress" class="dot-progress-button"></div>
                         <button type="button" id="publish-button" disabled="disabled" class="write-text-form-button" onclick="Joomla.submitbutton('article.save', true,'mytexts')">
                            <?php echo JText::_('PUBLISH_TEXT') ?>
                         </button>
                     </div>
				<?php }else{?>

                    <div id="save-button-container-2">
                        <div id="save-button-progress" class="dot-progress-button"></div>
                        <button type="button" id="save_button" style="" class="write-text-form-button" onclick="Joomla.submitbutton('article.save', false,'draft')">
                            Pasar a Borrador
                        </button>
                    </div>
				<?php }?>

                <button type="button" id="preview-button" class="write-text-form-button">
                    <?php echo JText::_('JPREVIEW') ?>
                </button>

            </div>

            <!--<div id="prueba-scroll" style="height: 200px; overflow: hidden; width: 500px;">
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>hola mundo cruel</p>
                <p>ya nunca te vere</p>
            </div>-->

        <div style="clear: both;"></div>
    </div>

		</div>

        <div style="display: none;">
            <input type="file" name="imagen1" id="imagen1" accept="image/png, image/gif, image/jpeg, image/jpg"/>
        </div>
		
	</fieldset>
		<input type="hidden" name="task" value="" />
		<?php if (isset($_GET["new"]) && $_GET["new"]=="1") { ?>
			<input type="hidden" name="jform[new]" value="1" />
		<?php }else{ ?>
			<input type="hidden" name="jform[new]" value="0" />
		<?php } ?>
		
		<?php if($this->params->get('enable_category', 0) == 1) :?>
		<input type="hidden" name="jform[catid]" value="<?php echo $this->params->get('catid', 1);?>"/>
		<?php endif;?>
		
		<input type="hidden" name="return" value="<?php echo $this->return_page;?>" />	
		<?php echo JHtml::_( 'form.token' ); ?>

</form>

</div>

<div id="preview-popup">

    <div id="preview-popup-category-color" style="background: #000000;"></div>

    <div id="preview-popup-buttons-container">
        <div id="back-to-edit-button" class="write-text-form-button"><?php echo JText::_('BACK_TO_EDITING') ?></div>

        <?php if ($this->item->state==0){?>
            <button id="preview-popup-publish-text-button" disabled="disabled" class="write-text-form-button" onclick="Joomla.submitbutton('article.save', true,'mytexts')"><?php echo JText::_('PUBLISH_TEXT') ?></button>
        <?php }else{?>
            <button id="preview-popup-publish-text-button" disabled="disabled" class="write-text-form-button" onclick="Joomla.submitbutton('article.save', true,'same')">Actualizar</button>
        <?php }?>

    </div>

    <div id="preview-popup-text-header">
        <div id="preview-popup-text-category" style="color: #000000;"></div>
        <div id="preview-popup-text-title"></div>
        <div id="preview-popup-text-author"></div>
    </div>

    <!--<div id="preview-popup-text-adjustments">
        <div id="preview-popup-text-a-plus"></div>
        <div id="preview-popup-text-a-minus"></div>
        <div id="preview-popup-text-contrast"></div>
    </div>-->

    <div id="preview-popup-text-content"></div>
    <div id="preview-popup-text-tags"></div>
</div>






<div id="forgot-password">

    <div id="close-forgot-pass-required-popup" class="close-button" title="<?php echo JText::_('CLOSE') ?>">
        <img src="<?php echo JURI::base() . "templates/beez_20/images/register-form-close-icon.png"; ?>"/>
    </div>

    <div id="forgot-password-title" class="with-pencil">¡Buen intento!</div>

    <div id="forgot-password-legend">Deb&eacute;s completar titulo y texto para poder guardarlo como borrador.</div>
</div>

<div id="reset-password">

    <div id="close-reset-pass-required-popup" class="close-button" title="<?php echo JText::_('CLOSE') ?>">
        <img src="<?php echo JURI::base() . "templates/beez_20/images/register-form-close-icon.png"; ?>"/>
    </div>

    <div id="reset-password-title" class="with-pencil">¡Buen intento!</div>

    <div id="reset-password-legend">Deb&eacute;s completar titulo, texto, tags y categoría para poder publicarlo.</div>
</div>